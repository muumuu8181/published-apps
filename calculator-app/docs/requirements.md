# 電卓アプリケーション要件定義書

## 1. プロジェクト概要

### 1.1 目的
コマンドラインとHTTPサーバーの両方で動作する、多機能な電卓アプリケーションを開発する。

### 1.2 スコープ
- 基本的な四則演算
- 高度な数学関数（三角関数、対数など）
- メモリ機能
- バッチ処理機能
- REST API提供

## 2. 機能要件

### 2.1 計算機能

#### 2.1.1 基本演算
- 加算（+）
- 減算（-）
- 乗算（*）
- 除算（/）
- 剰余（%）
- 累乗（^, **）

#### 2.1.2 数学関数
- 三角関数: sin, cos, tan
- 逆三角関数: asin, acos, atan
- 対数: log（自然対数）, log10（常用対数）
- 平方根: sqrt
- 絶対値: abs
- 切り上げ: ceil
- 切り下げ: floor
- 四捨五入: round

#### 2.1.3 定数
- PI（円周率）
- E（自然対数の底）

#### 2.1.4 メモリ機能
- M+: メモリに加算
- M-: メモリから減算
- MS: メモリに保存
- MR: メモリから読み出し
- MC: メモリクリア

### 2.2 動作モード

#### 2.2.1 対話型CLIモード
- プロンプトを表示して入力待機
- 計算式を入力してEnterで実行
- 結果を即座に表示
- "exit"または"quit"で終了

#### 2.2.2 バッチ処理モード
- コマンドライン引数で複数の式を処理
- ファイルから式を読み込んで一括処理
- 各計算結果を順番に出力

#### 2.2.3 HTTPサーバーモード
- RESTful APIとして動作
- POSTリクエストで計算式を受け取り
- JSON形式で結果を返却

### 2.3 エラーハンドリング

#### 2.3.1 入力検証
- 不正な文字の検出
- 構文エラーの検出
- 括弧の対応チェック

#### 2.3.2 計算エラー
- ゼロ除算の検出と処理
- オーバーフロー/アンダーフローの処理
- 数学的に定義されない演算の検出

#### 2.3.3 エラーメッセージ
- ユーザーフレンドリーなエラーメッセージ
- エラーの種類を明確に示す
- 可能な場合は修正方法を提案

## 3. 非機能要件

### 3.1 パフォーマンス
- 通常の計算は100ms以内に完了
- HTTPサーバーは同時に100リクエストを処理可能

### 3.2 信頼性
- 不正な入力でクラッシュしない
- メモリリークを起こさない
- 長時間稼働可能

### 3.3 移植性
- Node.js 18以上で動作
- OS非依存（Windows, macOS, Linux対応）
- 外部依存なしで動作

### 3.4 保守性
- モジュール化された設計
- 十分なコメントとドキュメント
- 包括的なテストスイート

## 4. インターフェース仕様

### 4.1 CLI インターフェース

```bash
# 対話モード
$ node app.js
> 2 + 3
5
> exit

# バッチモード
$ node app.js --batch "2+3" "4*5"
5
20

# ファイルからバッチ処理
$ node app.js --batch --file calculations.txt
```

### 4.2 HTTP API インターフェース

#### 4.2.1 計算エンドポイント
- **URL**: `/calculate`
- **Method**: `POST`
- **Content-Type**: `application/json`
- **Request Body**:
  ```json
  {
    "expression": "2 + 3 * 4"
  }
  ```
- **Success Response**:
  ```json
  {
    "result": 14,
    "expression": "2 + 3 * 4"
  }
  ```
- **Error Response**:
  ```json
  {
    "error": "Error message",
    "expression": "invalid expression"
  }
  ```

#### 4.2.2 ヘルスチェックエンドポイント
- **URL**: `/health`
- **Method**: `GET`
- **Response**:
  ```json
  {
    "status": "healthy",
    "uptime": 12345
  }
  ```

## 5. 実装要件

### 5.1 プロジェクト構造
```
calculator-app/
├── app.js              # メインエントリーポイント
├── src/
│   └── calculate.js    # 計算エンジン
├── test/
│   └── test.js         # テストスイート
├── docs/
│   └── requirements.md # この文書
├── package.json
└── README.md
```

### 5.2 コーディング規約
- ESモジュール形式を使用
- エラーは例外として投げる
- 非同期処理はPromise/async-awaitを使用

### 5.3 テスト要件
- 全ての計算機能をカバー
- エラーケースのテスト
- 各動作モードの統合テスト
- カバレッジ80%以上

## 6. 制約事項

### 6.1 技術的制約
- 純粋なNode.jsのみ使用（外部ライブラリなし）
- evalの使用は禁止（セキュリティのため）

### 6.2 セキュリティ制約
- 任意のコード実行を防ぐ
- DoS攻撃への対策
- 入力サイズの制限

## 7. 将来の拡張性

### 7.1 検討中の機能
- 計算履歴の保存
- カスタム関数の定義
- 単位変換機能
- グラフ描画機能

### 7.2 拡張ポイント
- プラグインシステムの実装
- 複数の出力形式対応
- WebSocket対応

## 8. リリース基準

### 8.1 完了条件
- 全機能要件の実装完了
- テストカバレッジ80%以上
- ドキュメント完備
- パフォーマンス基準を満たす

### 8.2 品質基準
- 重大なバグがない
- エラーハンドリングが適切
- コードレビュー完了